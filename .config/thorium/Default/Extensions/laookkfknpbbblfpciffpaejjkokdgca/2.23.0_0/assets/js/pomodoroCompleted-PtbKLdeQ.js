import{D as t,M as e,d as o,ag as s,ah as i,aK as a,c as r,g as n,q as u,u as c,n as d,r as l,w as p,e as h,F as y,x as g,E as f,A as T,aL as w,af as S}from"./dynamic-import-helper-Gh3O-GNF.js";import{t as v,a as P}from"./array-YYQw31d9.js";import{p as _}from"./persistStore-7VuxlznA.js";import{d as k}from"./focusModeState-D4CLHiD7.js";import{T as A,a as F}from"./PomodoroTimers-CyrfcuWH.js";import{persistentObjectSettings as D,computedObjectSettings as M}from"./reactiveCustomization-CaJFMm70.js";import{p as b}from"./promisifiedChrome-YDDyAvDe.js";import{L as E}from"./LocalStorageStoreSyncedItem-CtVH-muf.js";import{w as I}from"./login-kENE0gaj.js";import{o as B}from"./modal-D5eTjgvI.js";class C{constructor(t){this.dataService=t}get(t){this.dataService.get(t)}create(t){return this.dataService.create(t.id,t)}update(t,e){return this.dataService.update(t,e)}}const N=t=>t.reduce(((t,e)=>t+(e.manualAdjustment||0===e.focusMinutes?0:Number(e.aggregatedEntries))),0),L=t=>t.reduce(((t,e)=>t+Number(e.focusMinutes)),0);var j=(t=>(t.FocusEnd="PomodoroTimerEnd_focus",t.FocusAutoplayEnd="PomodoroTimerEnd_focus_autoplay",t.BreakEnd="PomodoroTimerEnd_rest",t.BreakAutoplayEnd="PomodoroTimerEnd_rest_autoplay",t))(j||{});const O=Object.values(j),x={PomodoroTimerEnd_focus:{exclusiveWith:O.filter((t=>"PomodoroTimerEnd_focus"!==t)),id:"PomodoroTimerEnd_focus",notification:{title:"👏 Nicely done! Time for a break.",message:"Take {{dynamic}} minutes to recharge.\nClick to start break.",buttons:[{title:"▶️ Start Break"},{title:"⏳ Focus +10min"}],iconUrl:"/img/app/icon-128.png",type:"basic",priority:2},type:"pomodoro"},PomodoroTimerEnd_focus_autoplay:{exclusiveWith:O.filter((t=>"PomodoroTimerEnd_focus_autoplay"!==t)),id:"PomodoroTimerEnd_focus_autoplay",notification:{title:"👏 Nicely done! Time for a break.",message:"Take {{dynamic}} minutes to recharge.\nYour break starts now.",buttons:[{title:"⏳ Focus +10min"},{title:"⏸️ Pause Break"}],iconUrl:"/img/app/icon-128.png",type:"basic",priority:2},type:"pomodoro"},PomodoroTimerEnd_rest:{exclusiveWith:O.filter((t=>"PomodoroTimerEnd_rest"!==t)),id:"PomodoroTimerEnd_rest",notification:{title:"🧠 Resume focus",message:"Try to focus during the next {{dynamic}} minutes. Click to start timer.",buttons:[{title:"▶️ Start Focus"},{title:"⏳ Break +10min"}],iconUrl:"/img/app/icon-128.png",type:"basic",priority:2},type:"pomodoro"},PomodoroTimerEnd_rest_autoplay:{exclusiveWith:O.filter((t=>"PomodoroTimerEnd_rest_autoplay"!==t)),id:"PomodoroTimerEnd_rest_autoplay",notification:{title:"🧠 Focus timer started",message:"Try to focus during the next {{dynamic}} minutes, starting now.",buttons:[{title:"⏳ Break +10min"},{title:"⏸️ Pause Focus"}],iconUrl:"/img/app/icon-128.png",type:"basic",priority:2},type:"pomodoro"}};var U=(t=>(t.StartBreak="startBreak",t.PauseBreak="pauseBreak",t.BreakPlus10="breakPlus10",t.StartFocus="startFocus",t.PauseFocus="pauseFocus",t.FocusPlus10="focusPlus10",t))(U||{});const R={PomodoroTimerEnd_focus:"startBreak",PomodoroTimerEnd_focus_0:"startBreak",PomodoroTimerEnd_focus_1:"focusPlus10",PomodoroTimerEnd_focus_autoplay:"",PomodoroTimerEnd_focus_autoplay_0:"focusPlus10",PomodoroTimerEnd_focus_autoplay_1:"pauseBreak",PomodoroTimerEnd_rest:"startFocus",PomodoroTimerEnd_rest_0:"startFocus",PomodoroTimerEnd_rest_1:"breakPlus10",PomodoroTimerEnd_rest_autoplay:"",PomodoroTimerEnd_rest_autoplay_0:"breakPlus10",PomodoroTimerEnd_rest_autoplay_1:"pauseFocus"},W=(t,e,o,i)=>{if(i)return{mode:A.CountDown,duration:i};let a=10*s;t===F.Focus&&(a=o.focusDuration*s),t===F.Break&&(a=o.restDuration*s);const r=k.currentValue&&e.pomodoroTimerMode||A.Timer;return r===A.CountUp&&(a=Number.POSITIVE_INFINITY),{mode:r,duration:a}},$=5*a,z={permissions:["notifications","alarms"]},q={permissions:["notifications"]};var V=(t=>(t[t.Play=0]="Play",t[t.Pause=1]="Pause",t))(V||{});const Y=20*s,J=90*s,K=3*i,G="lastInteraction";const H=new class{constructor(){this.state=r("active");const t=t=>{"active"!==t&&"active"===this.state.value&&this.setLastActivityToNow(),this.state.value="locked"===t?"idle":t,u((()=>{"active"===t&&this.setLastActivityToNow()}))};I().then((()=>{setInterval((()=>{n()&&"idle"in n()?n().idle.queryState(300,t):this.setLastActivityToNow()}),30*a),setTimeout((()=>this.setLastActivityToNow()),500)})),n()&&"idle"in n()&&(chrome.idle.setDetectionInterval(300),chrome.idle.onStateChanged.addListener(t))}getMsSinceLastInteraction(){const t=Date.now();return t-Number(localStorage.getItem(G)||t)}setLastActivityToNow(){localStorage.setItem(G,`${Date.now()}`)}},Q=async()=>{const t=H.getMsSinceLastInteraction(),e=Date.now()-t,o=st();return!o.loaded&&o.countUpActive&&o.playing&&t>Y&&await o.update({playing:!1,partialProgress:o.partialProgress+(e-o.timeStarted),pausedTimestampFromInactivity:e},!1),o.playing||!o.countUpActive||null===o.pausedTimestampFromInactivity?{}:t<=Y?{playing:!0,timeStarted:Date.now(),partialProgress:o.partialProgress+t,pausedTimestampFromInactivity:null}:t<=J?((async()=>{await c((()=>l.tabVisible)).toBe(!0),d.$emit("flashMessage",{message:"Your timer has been paused due to inactivity.",buttons:[{text:"I was focusing",action:()=>{o.update({playing:!0,timeStarted:Date.now(),partialProgress:o.partialProgress+(Date.now()-e)})},dismissOnClick:!0}],closeButtonEnabled:!0,persist:8e3})})(),{pausedTimestampFromInactivity:null}):t<=K?{pausedTimestampFromInactivity:null}:((async()=>{await c((()=>o.loaded)).toBe(!0),await o.complete({switchAfterComplete:!1,dateComplete:new Date(e).toISOString()}),await o.update({pausedTimestampFromInactivity:null})})(),{})},X=(t,e)=>{const o=structuredClone(D[t]);e(o),D[t]=o};const Z=new class{constructor(){this.getterDict={}}get(t,e){const o=this.getterDict[t];if(o)return o.lazyRef.value;const s=r(e()),i=p((()=>e()),((t,e)=>{let o=!1;o="object"==typeof t?JSON.stringify(t)!==JSON.stringify(e):t!==e,o&&(s.value=t)}));return this.getterDict[t]={lazyRef:s,unwatch:i},s.value}delete(t){var e,o;null==(o=null==(e=this.getterDict[t])?void 0:e.unwatch)||o.call(e),t in this.getterDict&&delete this.getterDict.key}},tt=new T({feature:"pomodoro"}),et=M,ot={start:{play:()=>new Audio("sounds/pomo-start.mp3").play()},stop:{play:()=>new Audio("sounds/pomo-stop.mp3").play()},done:{play:()=>new Audio("sounds/pomo-done.mp3").play()}},st=_((({loadedRef:t,updateAsync:e})=>h("pomodoroSession",{state:()=>({playing:!1,timeStarted:0,activeTimerId:F.Focus,partialProgress:0,pausedTimestampFromInactivity:null,countDownTimerLength:null}),getters:{loaded:()=>t.value,activeTimer(){return W(this.activeTimerId,et.focusModeSettings,this.pomodoroSettings,this.countDownTimerLength)},currentProgress(){return this.playing?m.models.date.get("seconds").getTime()-this.timeStarted:0},totalProgress(){return Math.min(this.totalLength,this.currentProgress+this.partialProgress)},totalLength(){return this.activeTimer.duration},timeRemaining(){return Math.max(0,Math.min(this.totalLength,this.totalLength-this.totalProgress))},anyFocusTimerActive(){return!!this.countUpActive||(!!this.countDownActive||[F.Focus,F.FocusPlusTen].includes(this.activeTimerId))},anyBreakTimerActive(){return!this.countUpActive&&(!this.countDownActive&&[F.Break,F.BreakPlusTen].includes(this.activeTimerId))},countUpActive(){return this.activeTimer.mode===A.CountUp},countDownActive(){return this.activeTimer.mode===A.CountDown},pomodoroSettings:()=>et.pomodoroSettings,focusedMinutes(){return Z.get("focusedMinutes",(()=>this.anyFocusTimerActive?Math.floor(this.totalProgress/s):0))},timeToDisplay(){return this.countUpActive?this.totalProgress:this.timeRemaining},hours(){return parseInt(Math.floor(this.timeToDisplay/i).toFixed(0))},minutes(){const t=(Math.floor(this.timeToDisplay/s)%60).toFixed(0);return(this.countUpActive||this.countDownActive)&&0===this.hours||this.pomodoroSettings.hideSeconds?t:v(t)},seconds(){return v((Math.floor(this.timeToDisplay/a)%60).toFixed(0))},fullTimeString(){return this.pomodoroSettings.hideSeconds?`${0!==this.hours?this.hours+"h ":""} ${this.minutes}m`:`${0!==this.hours?this.hours+":":""}${this.minutes}:${this.seconds}`}},actions:{async update(t,o){await e(t,o)},resume({playSounds:t=!1}={}){if(!this.playing)return this.pomodoroSettings.sounds&&t&&ot.start.play(),this.syncPendingNotification(),this.update({playing:!0,timeStarted:m.models.date.get("seconds").getTime()})},pause({playSounds:t=!1}={}){if(this.playing)return this.pomodoroSettings.sounds&&t&&ot.stop.play(),this.deleteNotification(),this.update({playing:!1,partialProgress:this.partialProgress+this.currentProgress})},async complete({switchAfterComplete:t=!0,completedManually:e=!1,switchToTimer:o,dateComplete:s=(new Date).toISOString(),playSounds:i=!0}={}){this.pomodoroSettings.sounds&&i&&this.totalProgress>0&&ot.done.play();let a=this.activeTimerId;o?a=o:t&&(a=this.anyFocusTimerActive?F.Break:F.Focus,this.pomodoroSettings.autoplay&&y(500).then((()=>{this.resume({playSounds:!1})})));const r=this.focusedMinutes;if(await this.update({playing:!1,partialProgress:0,activeTimerId:a}),r){const t=nt();t.refresh(),await c((()=>t.loaded)).toBe(!0);const e={focusMinutes:r,dateCreated:s,completed:s,aggregatedEntries:1,manualAdjustment:!1};0===t.data.length&&m.trigger("pomodoro:firstSessionCompleted"),await t.create(e),tt.capture("pomodoro complete",{period:this.activeTimerId,focusMinutes:r})}e&&await this.deleteNotification()},async switchTo(t,{startPlaying:e=!0,playSounds:o=!1}={}){this.activeTimerId!==t?(this.playing||0!==this.totalProgress?await this.complete({completedManually:!0,switchToTimer:t}):await this.update({activeTimerId:t}),e&&(await y(500),await this.resume({playSounds:o}))):e&&!this.playing&&await this.resume({playSounds:o})},async restartTimer(){const t=this.playing;await this.complete({switchAfterComplete:!1,completedManually:!0}),t&&await this.resume()},async deleteNotification(){await g.sendMessage({handler:"deleteNotification",args:[O],timeout:4e4})},async syncPendingNotification(t=!1){if(this.pomodoroSettings.browserNotifications){const e=t?this.anyFocusTimerActive?j.FocusAutoplayEnd:j.BreakAutoplayEnd:this.anyFocusTimerActive?j.FocusEnd:j.BreakEnd,o=W(this.anyFocusTimerActive?F.Break:F.Focus,et.focusModeSettings,this.pomodoroSettings,this.countDownTimerLength).duration/s,i={...structuredClone(x[e]),time:Date.now()+this.timeRemaining};i.notification.message=i.notification.message.replace("{{dynamic}}",`${o}`),f()&&delete i.notification.buttons,await g.sendMessage({handler:"createOrUpdateNotification",args:[i],timeout:4e4})}else await g.sendMessage({handler:"deleteNotificationsOfType",args:["pomodoro"]})},async onNotificationClick(t){switch(R[t]){case U.StartBreak:await this.switchTo(F.Break);break;case U.PauseBreak:this.playing&&this.anyBreakTimerActive&&await this.pause();break;case U.BreakPlus10:await this.switchTo(F.BreakPlusTen);break;case U.StartFocus:await this.switchTo(F.Focus);break;case U.PauseFocus:this.playing&&this.anyFocusTimerActive&&await this.pause();break;case U.FocusPlus10:await this.switchTo(F.FocusPlusTen)}},async ensureNotificationPermissions(){const t=await this.getNotificationsPermissionsToRequest(),e=!t||await B(t,{source:"Pomodoro",reason:"To show browser notifications"});this.saveSettingsToCustomization("browserNotifications",e)},async getNotificationsPermissionsToRequest(){const t=f()?q:z;return await b.permissions.contains(t)?null:t},saveSettingsToCustomization(t,e){X("pomodoroSettings",(o=>{o[t]=e})),this.playing&&this.syncPendingNotification()}}})),{mode:e.Cache,syncAutomatically:!0,fixStateBeforeLoad:async()=>await Q()}),it=new E("pomodoro-running",!1);(async()=>{const t=st();await c((()=>t.loaded)).toBe(!0),it.switchOverToWatchedStoreItem((()=>t.playing))})(),p(H.state,(async t=>{const e=st();"active"===t?await e.update(await Q()):(await c((()=>e.loaded)).toBe(!0),e.playing&&e.countUpActive&&(await e.pause(),await e.update({pausedTimestampFromInactivity:Date.now()})))}));const at=Object.freeze(Object.defineProperty({__proto__:null,default:st,usePomodoroSessionStore:st},Symbol.toStringTag,{value:"Module"})),rt=(s=(()=>({pomodoroCompletedService:new C(new t("pomodoro",{path:"pomodoro/completed",mode:e.Timestamp,getResponseProperty:"completed"}))}))().pomodoroCompletedService)=>h("pomodoroCompleted",{state:()=>({data:[],loading:!1,loaded:!1}),getters:{currentSessionLength(){const t=st();return t.pausedTimestampFromInactivity?0:t.focusedMinutes},dataWithCurrentSessionIfActive(t){const e=[...t.data];return this.currentSessionLength>0&&e.push({id:P(),completed:(new Date).toISOString(),focusMinutes:this.currentSessionLength,aggregatedEntries:1,manualAdjustment:!1}),e},completedStatsDaily(){return t=>{const e=Array(t+1).fill(void 0).map(((t,e)=>o.getDateStringDayOffset(-1*e))).map((t=>this.dataWithCurrentSessionIfActive.filter((e=>((t,e)=>t&&t.completed&&e.includes(o.getDateString(t.completed)))(e,[t])))));return{counts:e.map(N),focusedMinutes:e.map(L)}}},completedStats(){const t=this.completedStatsDaily(0),e=this.completedStatsDaily(m.models.date.get("hour").getDay());return{counts:{today:o.sumArray(t.counts),week:o.sumArray(e.counts),allTime:N(this.dataWithCurrentSessionIfActive)},focusedMinutes:{today:o.sumArray(t.focusedMinutes),week:o.sumArray(e.focusedMinutes),allTime:L(this.dataWithCurrentSessionIfActive)}}},allTimeMinutes(){return this.completedStats.focusedMinutes.allTime},weekMinutes(){return this.completedStats.focusedMinutes.week},todayMinutes(){return this.completedStats.focusedMinutes.today},pastDaysMinutes(){return t=>o.sumArray(this.completedStatsDaily(t).focusedMinutes)},allTime(){return w(60*this.allTimeMinutes*1e3)},week(){return w(60*this.weekMinutes*1e3)},today(){return w(60*this.todayMinutes*1e3)},completedCountSince(){return t=>this.dataWithCurrentSessionIfActive.filter((e=>new Date(e.completed).getTime()>t&&!e.manualAdjustment)).length},pastDays(){return t=>w(60*this.pastDaysMinutes(t)*1e3)}},actions:{refresh({daysNeeded:t=32}={}){let o=!1;const i=this.data.find((t=>t.aggregatedEntries>1));if(i){S(new Date(i.completed),new Date,0)<t&&(o=!0)}(o||!this.loaded&&!this.loading)&&(this.loading=!0,s.get({success:t=>{this.data=t||[],this.loaded=!0,this.loading=!1},queryParams:{cutoffDays:`${t}`},mode:o?e.Server:e.Timestamp}))},async create(t){const e={...t,id:o.uuidv4()};this.data.splice(this.data.length,0,e),await s.create(e)},async update(t,e){const o=this.data.findIndex((e=>e.id===t)),i=this.data[o];if(!i)throw new Error(`No data found for ${t}`);const a={...i,...e};return this.data.splice(o,1,a),await s.update(t,e),a}}}),nt=rt(),ut=Object.freeze(Object.defineProperty({__proto__:null,default:nt,makePomodoroCompletedStore:rt,usePomodoroCompletedStore:nt},Symbol.toStringTag,{value:"Module"}));export{V as P,$ as T,nt as a,at as b,ut as c,X as m,R as p,N as s,st as u};