import{y as e,ad as t,e as a,ae as s,af as n,ag as r,ah as i,V as d}from"./dynamic-import-helper-Gh3O-GNF.js";import{i as o}from"./index-D_K2V-H-.js";import{g as l}from"./accessToken-tlcZZvow.js";import{f as c}from"./string-DLOjEt1Y.js";import{m as u}from"./Logger-DgjqecXr.js";import{persistent as g}from"./reactiveCustomization-CaJFMm70.js";import"./array-YYQw31d9.js";import"./main-DaaZyiXy.js";import"./VueBase-CYtBAh2Z.js";import"./_commonjsHelpers-B3K3fdV-.js";import"./ClickOutside-DCLvi2fj.js";import"./pinia-CCjyjLnb.js";import"./portal-vue.esm-BTKM9g0x.js";class h{get(e,t){u.get("calendarData").then((t=>{const a=t;a&&a.length&&e(...a)})),this.refresh(e,t)}async refresh(t,a){var s,n;const r=await l();if(r)try{const{data:a}=await e.get("https://www.googleapis.com/calendar/v3/users/me/calendarList",{params:{access_token:r}}),s=a.items.map((e=>({id:e.id,summary:e.summary,timeZone:e.timeZone,backgroundColor:e.backgroundColor}))),n=(await Promise.all(s.map((e=>this.getCalendarEvents(e,r))))).flat();return await u.set("calendarData",[n,s]),void t(n,s)}catch(i){return console.error(i),void(o(i)&&(null==(n=null==(s=i.response)?void 0:s.status)?void 0:n.toString().startsWith("4"))?(await u.delete("calendarData"),t([],[])):a())}else t([],[])}async getCalendarEvents(a,s){const n=[];try{const{data:r}=await e.get(`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(a.id)}/events`,{params:{access_token:s,timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone,singleEvents:!0,orderBy:"startTime",timeMin:t(-1),timeMax:t(2)}}),i=r.items.filter((e=>{var t;return!(null==(t=e.attendees)?void 0:t.some((e=>!0===e.self&&"declined"===e.responseStatus)))})).map((e=>{var t;return{id:e.id,summary:e.summary||"No title",start:e.start.date?new Date(e.start.date+"T00:00:00.000").getTime():new Date(e.start.dateTime).getTime(),end:e.end.date?new Date(e.end.date+"T00:00:00.000").getTime():new Date(e.end.dateTime).getTime(),color:a.backgroundColor,calendarName:a.summary,calendarId:a.id,allDay:"date"in e.start,meetingLink:c(`${e.location} ${e.description} ${null==(t=e.conferenceData)?void 0:t.entryPoints.map((e=>e.uri||"")).join(" ")}`),link:e.htmlLink}}));n.push(...i)}catch(r){console.error(r),console.warn("No Events For Calendar:",a.summary)}return n}}const v=((e=(()=>({calendarEventService:new h}))().calendarEventService)=>a("calendarEvents",{state:()=>({data:{},loading:!1,loaded:!1,linked:!0,calendars:[],staleDataWarningVisible:!1}),getters:{events(){const e=[(new Date).getDate(),new Date(m.models.date.get("hour").getTime()+s).getDate()];return Object.values(this.data).filter((t=>e.includes(new Date(t.start).getDate())&&!this.excludedCalendars.includes(t.calendarId))).sort(((e,t)=>e.start-t.start))},getEventsForDay(){const e=new Date(m.models.date.get("hour"));return(t=0)=>this.loaded?this.events.filter((a=>n(e,new Date(a.start),0)===t)):[]},currentEvent(){return this.loaded?this.getEventsForDay(0).filter((e=>!e.allDay&&e.end>=m.models.date.get("date").getTime()))[0]??null:null},nextEvent(){return this.loaded?this.getEventsForDay(0).filter((e=>!e.allDay&&e.start>=m.models.date.get("date").getTime()))[0]??null:null},excludedCalendars:()=>JSON.parse(g.excludedCalendars),calendarList(){return this.calendars.map((e=>({...e,enabled:!this.excludedCalendars.includes(e.id)})))},calendarEventLabel(){return this.loading||!this.linked?"-":!1!==this.currentEventProgress?"Now":this.nextEvent?this.nextEvent.start>m.models.date.get("date").getTime()+45*r?Math.round((this.nextEvent.start-m.models.date.get("date").getTime())/i)+"h":Math.round((this.nextEvent.start-m.models.date.get("date").getTime())/r)+"m":"-"},currentEventProgress(){const e=m.models.date.get("date").getTime(),t=this.currentEvent;return!!(t&&t.start<e&&t.end>e)&&(e-t.start)/(t.end-t.start)},currentEventTitle(){var e;return this.loading?"Loading":this.linked?this.currentEvent?null==(e=this.currentEvent)?void 0:e.summary:"No events":"Calendar"}},actions:{refresh(t=!1){(t||!this.loading&&!this.loaded)&&(this.loading=!0,e.get(((e,t)=>{Object.keys(this.data).forEach((t=>{t in e||delete this.data[t]})),e.forEach((e=>d.set(this.data,e.id,e))),this.loaded=!0,this.loading=!1,t&&(this.calendars=t)}),(()=>{this.staleDataWarningVisible=!0})),l().then((e=>{this.linked=null!==e})))}}}))();export{v as useCalendarEventStore};